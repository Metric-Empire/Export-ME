name: Add-on Release

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Specific tag name"
        required: true
        type: string
jobs:
  build:
    runs-on: ubuntu-24.04
    env:
      RELEASE_VERSION: ${{ github.event.inputs.tag || github.ref_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set env
        run: echo "RELEASE_VERSION=${GITHUB_REF#refs/*/}" >> $GITHUB_ENV
      - name: Setup Python
        uses: actions/setup-python@v5.0.0
        with:
          python-version: "3.12"
      - name: Build
        run: |
          echo "Venv setup"
          python3 -m venv .venv
          source ./.venv/bin/activate
          echo "Building add-on"
          python ./scripts/build_nocheck.py
      - name: Release
        if: ${{ github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/') }}
        uses: softprops/action-gh-release@v2
        with:
          files: ./dist/Export-ME-${{ env.RELEASE_VERSION }}.zip
